<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <h1 class="title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</h1>
    </header>
    <div class="menu">
        <ul>
            <li><a href="/">üè†–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="/results">üìà–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a></li>
            <li><a href="/logout">üö™–í—ã–π—Ç–∏</a></li>
        </ul>
    </div>
    <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ {{ user.name }}</p>
    <div class="content">
        <table class="tasks">
            {% for row in tasks %}
            <tr>
                {% for task in row %}
                <td>
                    <div class="task" id={{ task.task.id }}>
                        <h2 class="task-title">{{ task.task.title }}</h2>
                        <p class="task-desc">{{ task.task.desc }}</p>
                        {% if task.task.material.all %}
                            üìé–†–∞–∑–¥–∞—Ç–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:<br>
                            {% for material in task.task.material.all %}
                                <a href="media/{{ material.file }}">{{ material.title }}</a>
                            {% endfor %}
                            <br>
                        {% endif %}
                        {% if task.task.is_manual %}
                            <span>‚úã–î–∞–Ω–Ω—ã–π —Ç–∞—Å–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é</span>
                        {% else %}
                            {% if task.solved %}
                                <span>üëç–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –¥–∞–Ω–Ω—ã–π —Ç–∞—Å–∫!</span>
                                <hr>
                                <div class="report" id={{ task.ts_obj.id }}>
                                    {% if not task.ts_obj.report %}
                                        <span id="report_status_{{ task.ts_obj.id }}">–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</span>
                                        <input type="file" name="file" id="file_{{ task.ts_obj.id }}"/>
                                        <br>
                                        <button id="report_{{ task.ts_obj.id }}">‚úÖ–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                    {% else %}
                                        <span id="report_status_{{ task.ts_obj.id }}">–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç—á–µ—Ç. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Ä–∞–∑–¥–µ–ª–µ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
                                    {% endif %}
                                    <script>
                                        $( "#report_{{ task.ts_obj.id }}" ).click(function() {
                                            var fd = new FormData();
                                            var files = $('#file_{{ task.ts_obj.id }}')[0].files;
                                            if (files.length > 0 ) {
                                                fd.append('file',files[0]);
                                            }
                                            $.ajax({
                                                url: "/report/{{ task.ts_obj.id }}/",
                                                type: "post",
                                                data: fd,
                                                contentType: false,
                                                processData: false,
                                                success: onAjaxSuccess
                                                });
                                    
                                                function onAjaxSuccess(data)
                                                {
                                                    data_json = JSON.parse(data);
                                                    if (data_json.status == 'ok') {
                                                        $("#report_status_{{ task.ts_obj.id }}").html('üëç–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
                                                    }
                                                    else {
                                                        $("#report_status_{{ task.ts_obj.id }}").html('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data_json.error);
                                                    }
                                                }
                                            });
                                    </script>
                                </div>
                            {% else %}
                                <input id="flag_input_{{ task.task.id }}" type="text" placeholder="üè≥Ô∏è–§–ª–∞–≥" name="flag">
                                <hr>
                                <button id="send_flag_{{ task.task.id }}">‚úÖ–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                <span id="status_{{ task.task.id }}"></span>
                                <script>
                                    $( "#send_flag_{{ task.task.id }}" ).click(function() {
                                        $.post(
                                            "/send_flag/{{ task.task.id }}/",
                                            {"flag": $("#flag_input_{{ task.task.id }}").val()},
                                            onAjaxSuccess
                                            );
                                
                                            function onAjaxSuccess(data)
                                            {
                                            data_json = JSON.parse(data);
                                            if (data_json.status == 'ok') {
                                                if (data_json.response == 'correct') {
                                                    $("#status_{{ task.task.id }}").html('üëç–í–µ—Ä–Ω—ã–π —Ñ–ª–∞–≥!');
                                                    setTimeout(
                                                        function() 
                                                        {
                                                            location.reload();
                                                        }, 2000
                                                    );
                                                }
                                                else {
                                                    $("#status_{{ task.task.id }}").html('üëé–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–ª–∞–≥!');
                                                }
                                                $("#w_new_pass").html('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ' + data_json.response.password);
                                                $("#w_old_pass").html('–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å: ' + data_json.response.password);
                                            }
                                            else {
                                                $("#status_{{ task.task.id }}").html('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data_json.error);
                                            }
                                            }
                                        });
                                </script>
                            {% endif %}
                        {% endif %}
                    </div>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>
</body>
</html>